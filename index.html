<!DOCTYPE html>
<html lang="ko">
<head>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1748676401736913" crossorigin="anonymous"></script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2ì¸ìš© ì²´ìŠ¤ (ìƒ‰ìƒ ì´ˆê¸°í™” + ì†Œë¦¬ í† ê¸€ + AI)</title>
<style>
  :root{
    --board-size: 800px;
    --light:#EEEED2;
    --dark:#769656;
    --piece-white:#ffffff;
    --piece-black:#111111;
    --select:#ffd43b88; --hint:#228be666; --capture:#fa525266;
    --mate-ring:#22c55e;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,sans-serif;display:grid;place-items:center;min-height:100vh;background:#0f172a;color:#e2e8f0;margin:0}
  .wrap{display:grid;grid-template-columns:var(--board-size) 360px;gap:20px;padding:24px;align-items:start}
  .panel{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:16px;box-shadow:0 10px 30px #0006}
  h1{font-size:20px;margin:0 0 12px;color:#f8fafc}
  .status{margin:6px 0 12px;font-weight:800;min-height:1.2em}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  button{background:#1f2937;border:1px solid #334155;color:#e2e8f0;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  button:hover{background:#0b7285;border-color:#0b7285}
  .log{height:calc(var(--board-size) - 280px);overflow:auto;background:#0b0f1a;border:1px solid #1e293b;border-radius:10px;padding:8px;font-family:ui-monospace,Menlo,monospace}
  .log div{padding:4px 6px;border-radius:6px}
  .log div:nth-child(odd){background:#0f172a}

  .board{width:var(--board-size);height:var(--board-size);display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(8,1fr);
    border:10px solid #0b0f1a;border-radius:16px;box-shadow:0 20px 60px #0008,inset 0 0 0 1px #1f2937;position:relative;overflow:hidden}
  .sq{display:flex;align-items:center;justify-content:center;font-size:calc(var(--board-size)/10);user-select:none;position:relative}
  .sq.light{background:var(--light)} .sq.dark{background:var(--dark)}
  .sq.coord::after{content:attr(data-ax);position:absolute;left:6px;bottom:4px;font-size:12px;color:#000a;font-weight:800}
  .piece{line-height:1;-webkit-text-stroke:2px #000;-webkit-text-fill-color: currentColor;filter:drop-shadow(0 1px 0 #0006) drop-shadow(0 6px 8px #0005)}
  .piece.w{color:var(--piece-white)} .piece.b{color:var(--piece-black)}
  .sq.selected{box-shadow:inset 0 0 0 4px var(--select)}
  .sq.hint::before{content:"";position:absolute;width:26%;height:26%;border-radius:50%;background:var(--hint);box-shadow:0 0 0 4px #0003}
  .sq.capture::before{content:"";position:absolute;inset:12%;border:4px dashed #e03131cc;border-radius:12px;background: var(--capture)}
  .sq.in-check{box-shadow:inset 0 0 0 5px #ff2b2bcc, 0 0 20px #ff2b2b66}
  .sq.mate-king{box-shadow:inset 0 0 0 5px var(--mate-ring), 0 0 20px #22c55e99}

  .overlay{position:absolute;inset:0;background:#0008;display:grid;place-items:center;z-index:5}
  .card{background:#0b0f1a;border:1px solid #1e293b;border-radius:12px;padding:14px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;min-width:260px}
  .overlay h2{margin:0 0 8px;font-size:18px;text-align:center;width:100%}
  .overlay p{margin:0 6px 6px;opacity:.85;width:100%;text-align:center}
  .promo .card button{font-size:28px;padding:10px 14px}
  .result .card button{padding:8px 12px}

  .colors{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0 10px}
  .color-item{display:flex;align-items:center;justify-content:space-between;gap:8px;background:#0b0f1a;border:1px solid #1e293b;border-radius:10px;padding:8px}
  .color-item label{font-size:12px;opacity:.9}
  .color-item input[type="color"]{width:42px;height:28px;border:none;background:transparent;padding:0;cursor:pointer}

  .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .foot{opacity:.7;font-size:12px;margin-top:8px}

  .ai{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0}
  .ai .full{grid-column:1/-1}
  select{background:#0b1220;border:1px solid #1e293b;color:#e2e8f0;border-radius:10px;padding:8px}
  .muted{opacity:.7}
</style>
</head>
<body>
  <div class="wrap">
    <div class="board" id="board" aria-label="ì²´ìŠ¤ ë³´ë“œ"></div>

    <div class="panel">
      <h1> ì²´í¬ë©”ì´íŠ¸ ë™ì•„ë¦¬ ì²´ìŠ¤ ì‚¬ì´íŠ¸(made by mtai_tfcs)</h1>
      <div class="status" id="status">ë°± ì°¨ë¡€ (White to move)</div>

      <!-- ìƒ‰ìƒ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ -->
      <div class="colors">
        <div class="color-item"><label>ë°ì€ ì¹¸</label><input id="lightColor" type="color" value="#EEEED2" /></div>
        <div class="color-item"><label>ì–´ë‘ìš´ ì¹¸</label><input id="darkColor" type="color" value="#769656" /></div>
        <div class="color-item"><label>ë°± ê¸°ë¬¼</label><input id="whitePiece" type="color" value="#ffffff" /></div>
        <div class="color-item"><label>í‘ ê¸°ë¬¼</label><input id="blackPiece" type="color" value="#111111" /></div>
      </div>

      <!-- AI ì„¤ì • -->
      <div class="ai">
        <div>
          <label class="muted">ë‚œì´ë„</label>
          <select id="aiLevel">
            <option value="easy">ver1 </option>
            <option value="medium" selected>ver2 </option>
            <option value="hard">ver3 </option>
          </select>
        </div>
        <div>
          <label class="muted">ë‚´ ìƒ‰</label>
          <select id="humanSide">
            <option value="w" selected>ë°±</option>
            <option value="b">í‘</option>
          </select>
        </div>
        <button id="aiToggleBtn" class="full">ğŸ¤– AI ì‹œì‘</button>
      </div>

      <div class="row">
        <button id="resetColorsBtn">ğŸ¨ ê¸°ë³¸ ìƒ‰ìœ¼ë¡œ</button>
        <button id="soundToggleBtn">ğŸ”Š ì†Œë¦¬: ì¼¬</button>
      </div>

      <div class="btns">
        <button id="undoBtn">â†¶ ë˜ëŒë¦¬ê¸°</button>
        <button id="resetBtn">â™» ë¦¬ì…‹</button>
        <button id="flipBtn">â¤¿ ë³´ë“œ ë’¤ì§‘ê¸°</button>
      </div>
      <div class="log" id="log" aria-label="ì´ë™ ê¸°ë¡"></div>
      <div class="foot">ê·œì¹™: ì²´í¬/ë©”ì´íŠ¸/ìŠ¤í…Œì¼, í”„ë¡œëª¨ì…˜, ìºìŠ¬ë§ í¬í•¨. (ì•™íŒŒìƒ ë¯¸í¬í•¨)</div>
    </div>
  </div>

<script>
/* ===================== ê¸°ë³¸ ì„¤ì • ===================== */
const files=['a','b','c','d','e','f','g','h'];
const ranks=[8,7,6,5,4,3,2,1];
const boardEl=document.getElementById('board');
const statusEl=document.getElementById('status');
const logEl=document.getElementById('log');

const undoBtn=document.getElementById('undoBtn');
const resetBtn=document.getElementById('resetBtn');
const flipBtn=document.getElementById('flipBtn');
const resetColorsBtn=document.getElementById('resetColorsBtn');
const soundToggleBtn=document.getElementById('soundToggleBtn');
const aiToggleBtn=document.getElementById('aiToggleBtn');
const aiLevelSel=document.getElementById('aiLevel');
const humanSideSel=document.getElementById('humanSide');

const lightPicker = document.getElementById('lightColor');
const darkPicker  = document.getElementById('darkColor');
const whitePiecePicker = document.getElementById('whitePiece');
const blackPiecePicker = document.getElementById('blackPiece');

const COLOR_DEFAULTS = { light:'#EEEED2', dark:'#769656', w:'#ffffff', b:'#111111' };

let state, selected=null, hints=new Set(), captures=new Set(), history=[], flipped=false;
let checkSquare=null;   // ì²´í¬ ì¤‘ í‚¹ ìœ„ì¹˜
let mateSquare=null;    // ë©”ì´íŠ¸ëœ í‚¹ ìœ„ì¹˜(ì´ˆë¡)
let gameOver=false;

const UNI={ w:{K:'â™”',Q:'â™•',R:'â™–',B:'â™—',N:'â™˜',P:'â™™'}, b:{K:'â™š',Q:'â™›',R:'â™œ',B:'â™',N:'â™',P:'â™Ÿ'} };

/* ===================== ì˜¤ë””ì˜¤: â€œíƒâ€ ì†Œë¦¬ & í† ê¸€ ===================== */
let soundOn = true;
let actx=null;
function ctx(){
  actx = actx || new (window.AudioContext || window.webkitAudioContext)();
  if (actx.state === 'suspended') { actx.resume().catch(()=>{}); }
  return actx;
}
function ping(ms=160){
  if(!soundOn) return;
  try{
    const a=ctx();
    const o=a.createOscillator(), g=a.createGain();
    o.type='triangle';
    o.frequency.setValueAtTime(880,a.currentTime);
    o.frequency.exponentialRampToValueAtTime(740,a.currentTime+ms/1000);
    g.gain.setValueAtTime(0.0001,a.currentTime);
    g.gain.exponentialRampToValueAtTime(0.25,a.currentTime+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,a.currentTime+ms/1000);
    o.connect(g).connect(a.destination);
    o.start(); o.stop(a.currentTime+ms/1000+0.02);
  }catch(e){}
}
function thock(ms=120){
  if(!soundOn) return;
  try{
    actx = actx || new (window.AudioContext||window.webkitAudioContext)();
    const o = actx.createOscillator();
    const g = actx.createGain();
    const lp = actx.createBiquadFilter();
    o.type = 'square';
    o.frequency.setValueAtTime(220, actx.currentTime);
    o.frequency.exponentialRampToValueAtTime(140, actx.currentTime + ms/1000);
    g.gain.setValueAtTime(0.0001, actx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.35, actx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime + ms/1000);
    lp.type = 'lowpass';
    lp.frequency.setValueAtTime(1200, actx.currentTime);
    o.connect(g).connect(lp).connect(actx.destination);
    o.start(); o.stop(actx.currentTime + ms/1000 + 0.02);
  }catch(e){}
}
function toggleSound(){
  soundOn = !soundOn;
  soundToggleBtn.textContent = soundOn ? 'ğŸ”Š ì†Œë¦¬: ì¼¬' : 'ğŸ”‡ ì†Œë¦¬: ë”';
}

/* ===================== ìƒíƒœ/ë³´ë“œ ===================== */
function initState(){
  const empty=Array.from({length:8},()=>Array(8).fill(null));
  const place=(r,f,c,t)=> empty[r][f]={c,t,moved:false};
  const back=['R','N','B','Q','K','B','N','R'];
  // black
  back.forEach((t,f)=>place(0,f,'b',t)); for(let f=0; f<8; f++) place(1,f,'b','P');
  // white
  for(let f=0; f<8; f++) place(6,f,'w','P'); back.forEach((t,f)=>place(7,f,'w',t));
  return {board:empty, turn:'w'};
}
function cloneState(s){ return {board: s.board.map(row=>row.map(x=>x?{...x}:null)), turn:s.turn}; }
function toAlg(r,c){ return files[c]+ranks[r]; }

function draw(){
  boardEl.innerHTML='';
  const rankOrder=flipped?[...ranks].reverse():ranks;
  const fileOrder=flipped?[...files].reverse():files;
  for(let ri=0;ri<8;ri++){
    for(let fi=0;fi<8;fi++){
      const r=ranks.indexOf(rankOrder[ri]);
      const c=files.indexOf(fileOrder[fi]);
      const sq=document.createElement('div');
      sq.className=`sq ${(r+c)%2===0?'light':'dark'}`;
      sq.dataset.r=r; sq.dataset.c=c;
      if((!flipped && r===7) || (flipped && r===7)){ sq.classList.add('coord'); sq.dataset.ax=fileOrder[fi]; }
      const p=state.board[r][c];
      if(p){ const el=document.createElement('div'); el.className=`piece ${p.c}`; el.textContent=UNI[p.c][p.t]; sq.appendChild(el); }
      if(selected && selected[0]===r && selected[1]===c) sq.classList.add('selected');
      const k=`${r}-${c}`; if(hints.has(k)) sq.classList.add('hint'); if(captures.has(k)) sq.classList.add('capture');
      if(mateSquare && mateSquare.r===r && mateSquare.c===c) sq.classList.add('mate-king');
      else if(checkSquare && checkSquare.r===r && checkSquare.c===c) sq.classList.add('in-check');

      sq.addEventListener('click',()=>onSquare(r,c));
      boardEl.appendChild(sq);
    }
  }
  if(!gameOver){
    statusEl.textContent = state.turn==='w' ? 'ë°± ì°¨ë¡€ (White to move)' : 'í‘ ì°¨ë¡€ (Black to move)';
  } else {
    statusEl.textContent = '';
  }
}

/* ===================== ì…ë ¥/ì„ íƒ ===================== */
function onSquare(r,c){
  if(gameOver) return;
  if(isAITurn()) return; // AI ì°¨ë¡€ì—ëŠ” í´ë¦­ ë§‰ê¸°
  const here=state.board[r][c];
  if(selected){
    const [sr,sc]=selected;
    const legal=getLegalMovesFiltered(sr,sc);
    const mv=legal.find(m=>m.r===r && m.c===c);
    if(mv){ doMove(sr,sc,r,c,mv); return; }
  }
  if(here && here.c===state.turn){ selected=[r,c]; setHints(getLegalMovesFiltered(r,c)); draw(); }
  else { clearSel(); draw(); }
}

function setHints(moves){ hints.clear(); captures.clear(); moves.forEach(m=>{const k=`${m.r}-${m.c}`; (m.capture?captures:hints).add(k);}); }
function clearSel(){ selected=null; hints.clear(); captures.clear(); }

/* ===================== ì´ë™ ìƒì„±ê¸°(ì˜ì‚¬í•©ë²• + ìºìŠ¬ë§ í›„ë³´) ===================== */
function pseudoMoves(r,c){
  return pseudoMovesIn(state,r,c);
}
function pseudoMovesIn(s,r,c){
  const p=s.board[r][c]; if(!p) return [];
  const out=[];
  const same=(rr,cc)=> s.board[rr]?.[cc]?.c===p.c;
  const foe =(rr,cc)=> s.board[rr]?.[cc] && s.board[rr][cc].c!==p.c;
  const empty=(rr,cc)=> !s.board[rr]?.[cc];
  const push=(rr,cc,capture=false, special=null)=>{ if(rr<0||rr>7||cc<0||cc>7) return; if(same(rr,cc)) return; out.push({r:rr,c:cc,capture,special}); };

  if(p.t==='N'){
    [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(([dr,dc])=>{
      const rr=r+dr, cc=c+dc; if(rr<0||rr>7||cc<0||cc>7) return; if(same(rr,cc)) return; push(rr,cc,!!foe(rr,cc));
    });
  }
  if(p.t==='K'){
    for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
      if(!dr && !dc) continue; const rr=r+dr, cc=c+dc; if(rr<0||rr>7||cc<0||cc>7) continue; if(same(rr,cc)) continue; push(rr,cc,!!foe(rr,cc));
    }
    if(!p.moved){
      if(canCastleSideCandidate(s, p.c, 'king')) push(r,6,false,{castle:'king'});
      if(canCastleSideCandidate(s, p.c, 'queen')) push(r,2,false,{castle:'queen'});
    }
  }
  const slide=(dirs)=>{
    for(const [dr,dc] of dirs){
      let rr=r+dr, cc=c+dc;
      while(rr>=0&&rr<8&&cc>=0&&cc<8){
        if(s.board[rr][cc]){
          if(foe(rr,cc)) push(rr,cc,true);
          break;
        } else { push(rr,cc,false); }
        rr+=dr; cc+=dc;
      }
    }
  };
  if(p.t==='B') slide([[1,1],[1,-1],[-1,1],[-1,-1]]);
  if(p.t==='R') slide([[1,0],[-1,0],[0,1],[0,-1]]);
  if(p.t==='Q') slide([[1,1],[1,-1],[-1,1],[-1,-1],[1,0],[-1,0],[0,1],[0,-1]]);

  if(p.t==='P'){
    const dir=p.c==='w'?-1:1, start=p.c==='w'?6:1;
    if(empty(r+dir,c)) push(r+dir,c,false);
    if(r===start && empty(r+dir,c) && empty(r+2*dir,c)) push(r+2*dir,c,false);
    for(const dc of [-1,1]){
      const rr=r+dir, cc=c+dc;
      if(rr>=0&&rr<8&&cc>=0&&cc<8 && s.board[rr][cc] && s.board[rr][cc].c!==p.c) push(rr,cc,true);
    }
  }
  return out;
}

/* ===================== ìºìŠ¬ë§ íŒë‹¨ ===================== */
function canCastleSideCandidate(s, color, side){
  const row = (color==='w') ? 7 : 0;
  const king = s.board[row][4];
  if(!king || king.t!=='K' || king.moved) return false;
  if(side==='king'){
    const rook = s.board[row][7];
    if(!rook || rook.t!=='R' || rook.moved) return false;
    return !s.board[row][5] && !s.board[row][6];
  } else {
    const rook = s.board[row][0];
    if(!rook || rook.t!=='R' || rook.moved) return false;
    return !s.board[row][1] && !s.board[row][2] && !s.board[row][3];
  }
}
function canCastle(s, color, side){
  if(inCheck(s, color)) return false;
  if(!canCastleSideCandidate(s, color, side)) return false;
  const row = (color==='w') ? 7 : 0;
  const foe = (color==='w') ? 'b' : 'w';
  if(side==='king'){
    if(squareAttackedBy(s, foe, row, 5)) return false;
    if(squareAttackedBy(s, foe, row, 6)) return false;
    return true;
  } else {
    if(squareAttackedBy(s, foe, row, 3)) return false;
    if(squareAttackedBy(s, foe, row, 2)) return false;
    return true;
  }
}

/* ===================== ì²´í¬ íŒì • ìœ í‹¸ ===================== */
function findKing(s, color){
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const p=s.board[r][c]; if(p && p.c===color && p.t==='K') return {r,c};
  } return null;
}
function squareAttackedBy(s, color, r, c){
  const N=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];
  for(const [dr,dc] of N){ const rr=r+dr, cc=c+dc; const q=s.board[rr]?.[cc]; if(q && q.c===color && q.t==='N') return true; }
  for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){ if(!dr && !dc) continue; const q=s.board[r+dr]?.[c+dc]; if(q && q.c===color && q.t==='K') return true; }
  const dir=color==='w'?-1:1; for(const dc of [-1,1]){ const q=s.board[r-dir]?.[c-dc]; if(q && q.c===color && q.t==='P') return true; }
  const rays=[[1,1],[1,-1],[-1,1],[-1,-1],[1,0],[-1,0],[0,1],[0,-1]];
  for(let i=0;i<rays.length;i++){
    let [dr,dc]=rays[i], rr=r+dr, cc=c+dc;
    while(rr>=0&&rr<8&&cc>=0&&cc<8){
      const q=s.board[rr][cc];
      if(q){
        if(q.c===color){
          if(i<4 && (q.t==='B'||q.t==='Q')) return true;
          if(i>=4 && (q.t==='R'||q.t==='Q')) return true;
        }
        break;
      }
      rr+=dr; cc+=dc;
    }
  }
  return false;
}
function inCheck(s, color){
  const k=findKing(s,color); if(!k) return false;
  const foe = color==='w'?'b':'w';
  return squareAttackedBy(s, foe, k.r, k.c);
}

/* ì˜ì‚¬ì´ë™ ì ìš© */
function applyMove(s, sr,sc,tr,tc, promotionT=null){
  const ns=cloneState(s);
  const piece=ns.board[sr][sc];
  ns.board[tr][tc] = {...piece, moved:true};
  ns.board[sr][sc] = null;
  if(piece.t==='K' && Math.abs(tc-sc)===2){
    const row=sr;
    if(tc===6){ ns.board[row][5] = {...ns.board[row][7], moved:true}; ns.board[row][7]=null; }
    if(tc===2){ ns.board[row][3] = {...ns.board[row][0], moved:true}; ns.board[row][0]=null; }
  }
  if(promotionT && piece.t==='P' && (tr===0 || tr===7)){
    ns.board[tr][tc] = {c: piece.c, t: promotionT, moved:true};
  }
  ns.turn = ns.turn==='w' ? 'b' : 'w';
  return ns;
}

/* ìê¸° í‚¹ ë…¸ì¶œ ì œê±° + ìºìŠ¬ë§ í•©ë²•ì„± ë°˜ì˜ */
function getLegalMovesFiltered(r,c){
  const p=state.board[r][c]; if(!p) return [];
  const pseudo=pseudoMoves(r,c);
  const legal=[];
  for(const m of pseudo){
    if(p.t==='K' && m.special?.castle){
      if(!canCastle(state, p.c, m.special.castle)) continue;
    }
    const willPromote = (p.t==='P' && (m.r===0 || m.r===7));
    const ns=applyMove(state, r,c, m.r,m.c, willPromote ? 'Q' : null);
    if(!inCheck(ns, p.c)) legal.push(m);
  }
  return legal;
}
function allLegalMovesOf(color){
  const res=[];
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const p=state.board[r][c];
    if(p && p.c===color){
      const ms=getLegalMovesFiltered(r,c);
      if(ms.length) res.push({r,c,moves:ms});
    }
  }
  return res;
}

/* ======== (AIìš©) íŠ¹ì • ìƒíƒœ sì— ëŒ€í•œ í•©ë²• ìˆ˜ ìƒì„± ======== */
function legalMovesIn(s, color){
  const result=[];
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const p=s.board[r][c]; if(!p || p.c!==color) continue;
    const pm=pseudoMovesIn(s,r,c);
    for(const m of pm){
      if(p.t==='K' && m.special?.castle){
        if(!canCastle(s, color, m.special.castle)) continue;
      }
      const promo = (p.t==='P' && (m.r===0 || m.r===7));
      const ns=applyMove(s, r,c, m.r,m.c, promo?'Q':null); // íƒìƒ‰ì—ì„œëŠ” í€¸ ìŠ¹ê²© ê°€ì •
      if(!inCheck(ns, p.c)){
        result.push({sr:r,sc:c,tr:m.r,tc:m.c,capture:!!m.capture, special:m.special||null, promo:promo});
      }
    }
  }
  return result;
}

/* ===================== ì‹¤í–‰/íˆìŠ¤í† ë¦¬ ===================== */
let aiAutoQueen=false; // AIê°€ ë‘ëŠ” ì°¨ë¡€ì— ìŠ¹ê²© ì‹œ ìë™ í€¸
function doMove(sr,sc,tr,tc, meta={}){
  if(gameOver) return;
  const piece=state.board[sr][sc];
  const captured=state.board[tr][tc] ? {...state.board[tr][tc]} : null;

  state.board[tr][tc]={...piece,moved:true};
  state.board[sr][sc]=null;

  if(piece.t==='K' && Math.abs(tc-sc)===2){
    const row=sr;
    if(tc===6){ state.board[row][5] = {...state.board[row][7], moved:true}; state.board[row][7] = null; }
    else if(tc===2){ state.board[row][3] = {...state.board[row][0], moved:true}; state.board[row][0] = null; }
  }

  const finalize = (extra={})=>{
    pushHistory(sr,sc,tr,tc,captured,state.board[tr][tc],extra);
    thock(110);
    state.turn = state.turn==='w' ? 'b' : 'w';
    evaluateTurn();
    clearSel(); draw();
  };

  if(piece.t==='P' && (tr===0 || tr===7)){
    if(aiAutoQueen){
      state.board[tr][tc]={c:piece.c,t:'Q',moved:true};
      finalize({promotion:'Q'});
    }else{
      showPromotion(piece.c,(t)=>{
        state.board[tr][tc]={c:piece.c,t,moved:true};
        finalize({promotion:t});
      });
    }
    return;
  }

  finalize({});
}

function pushHistory(sr,sc,tr,tc,captured,afterPiece,extra){
  history.push({ before: JSON.parse(JSON.stringify(state.board)),
    move:{from:[sr,sc],to:[tr,tc],notation:`${toAlg(sr,sc)}-${toAlg(tr,tc)}`,captured, piece:afterPiece, extra},
    turn: state.turn });
  const m=history.at(-1).move;
  const div=document.createElement('div');
  const icon=UNI[m.piece.c][m.piece.t];
  const cap=m.captured ? ` Ã—${UNI[m.captured.c][m.captured.t]}` : '';
  const promo=m.extra?.promotion ? ` =${m.extra.promotion}` : '';
  const castleNote = (m.piece.t==='K' && Math.abs(m.to[1]-m.from[1])===2) ? (m.to[1]===6?' O-O':' O-O-O') : '';
  div.textContent=`${icon}  ${m.notation}${cap}${promo}${castleNote}`;
  logEl.appendChild(div); logEl.scrollTop=logEl.scrollHeight;
}

/* ===================== ë˜ëŒë¦¬ê¸°/ë¦¬ì…‹/ë’¤ì§‘ê¸° ===================== */
function undo(){
  if(gameOver) return;
  const last=history.pop(); if(!last) return;
  state.board=last.before; state.turn=last.turn; checkSquare=null; mateSquare=null;
  clearSel(); draw();
  if(logEl.lastChild) logEl.removeChild(logEl.lastChild);
}
function reset(){
  state=initState(); history=[]; clearSel(); checkSquare=null; mateSquare=null; gameOver=false; logEl.innerHTML='';
  statusEl.textContent='ë°± ì°¨ë¡€ (White to move)'; draw();
  maybeAIMove(); // ì‹œì‘í•˜ìë§ˆì AI ì°¨ë¡€ë©´ ë‘ë„ë¡
}
function flip(){ flipped=!flipped; draw(); }

/* ===================== ì²´í¬/ë©”ì´íŠ¸ í‰ê°€ & UI ===================== */
function evaluateTurn(){
  const toMove=state.turn;
  const foe = toMove==='w'?'b':'w';
  const k=findKing(state,toMove);
  const isCheck=inCheck(state,toMove);
  checkSquare = isCheck ? k : null;
  mateSquare = null;

  const moves=allLegalMovesOf(toMove);
  const hasMove = moves.length>0;

  if(!hasMove){
    if(isCheck){
      gameOver = true;
      ping(160);
      mateSquare = k;
      statusEl.textContent = '';
      showResult('ì²´í¬ë©”ì´íŠ¸!', `${foe==='w'?'ë°±':'í‘'} ìŠ¹ë¦¬`);
    }else{
      ping(160);
      gameOver = true;
      statusEl.textContent = '';
      showResult('ë¬´ìŠ¹ë¶€', 'ìŠ¤í…Œì¼ë©”ì´íŠ¸');
    }
  }else{
    let s = (toMove==='w'?'ë°±':'í‘')+' ì°¨ë¡€';
    if(isCheck) {s += ' â€” ì²´í¬!'; ping(160);}
    statusEl.textContent = s + (toMove==='w'?' (White to move)':' (Black to move)');
    maybeAIMove();
  }
}

/* ê²°ê³¼ ëª¨ë‹¬(ê°€ìš´ë°) */
function showResult(title, subtitle){
  const overlay=document.createElement('div'); overlay.className='overlay result';
  const card=document.createElement('div'); card.className='card';
  const h2=document.createElement('h2'); h2.textContent=title;
  const p=document.createElement('p'); p.textContent=subtitle;
  const btn1=document.createElement('button'); btn1.textContent='ë¦¬ì…‹'; btn1.addEventListener('click',()=>{ overlay.remove(); reset(); });
  const btn2=document.createElement('button'); btn2.textContent='ë‹«ê¸°'; btn2.addEventListener('click',()=>overlay.remove());
  card.append(h2,p,btn1,btn2); overlay.appendChild(card); boardEl.appendChild(overlay);
}

/* í”„ë¡œëª¨ì…˜ ëª¨ë‹¬ */
function showPromotion(color, onPick){
  const overlay=document.createElement('div'); overlay.className='overlay promo';
  const card=document.createElement('div'); card.className='card';
  const h2=document.createElement('h2'); h2.textContent='í”„ë¡œëª¨ì…˜í•  ê¸°ë¬¼ì„ ì„ íƒí•˜ì„¸ìš”';
  const choices=['Q','R','B','N'];
  card.appendChild(h2);
  choices.forEach(t=>{
    const b=document.createElement('button'); b.textContent=UNI[color][t];
    b.title=({Q:'í€¸',R:'ë£©',B:'ë¹„ìˆ',N:'ë‚˜ì´íŠ¸'})[t];
    b.addEventListener('click',()=>{ overlay.remove(); onPick(t); });
    card.appendChild(b);
  });
  overlay.appendChild(card); boardEl.appendChild(overlay);
}

/* ===================== ìƒ‰ìƒ: ë°”ì¸ë”© & ì´ˆê¸°í™” ===================== */
function setCSS(varName, value){ document.documentElement.style.setProperty(varName, value); }
function applyPickerVars(){
  setCSS('--light', lightPicker.value);
  setCSS('--dark', darkPicker.value);
  setCSS('--piece-white', whitePiecePicker.value);
  setCSS('--piece-black', blackPiecePicker.value);
}
function bindColorPickers(){ [lightPicker, darkPicker, whitePiecePicker, blackPiecePicker].forEach(inp=> inp.addEventListener('input', applyPickerVars)); }
function resetColors(){
  lightPicker.value = COLOR_DEFAULTS.light;
  darkPicker.value  = COLOR_DEFAULTS.dark;
  whitePiecePicker.value = COLOR_DEFAULTS.w;
  blackPiecePicker.value = COLOR_DEFAULTS.b;
  applyPickerVars();
}

/* ===================== AI ë¡œì§ ===================== */
let aiEnabled=false;
let humanSide='w'; // ì‚¬ëŒì´ ë‘ëŠ” ìƒ‰
let aiTimer=null;

function isAITurn(){
  const aiSide = (humanSide==='w') ? 'b' : 'w';
  return aiEnabled && !gameOver && state.turn===aiSide;
}
function maybeAIMove(){
  if(!isAITurn()) return;
  if(aiTimer) return;
  aiTimer = setTimeout(()=>{
    aiTimer=null;
    const aiSide = state.turn;
    const level = aiLevelSel.value;
    const move = chooseAIMove(level, aiSide);
    if(move){
      aiAutoQueen = true;
      doMove(move.sr, move.sc, move.tr, move.tc, {});
      aiAutoQueen = false;
    }else{
      // ìˆ˜ê°€ ì—†ìœ¼ë©´ evaluateTurnì—ì„œ ì²˜ë¦¬ë¨
    }
  }, 800);
}

/* í‰ê°€ í•¨ìˆ˜ */
const PIECE_VAL = {K:10000,Q:900,R:500,B:330,N:320,P:100};
function evaluateBoardSimple(s, pov='w'){
  // ë§ê°€ì¹˜ + í™œë™ì„± + ì²´í¬ ë³´ë„ˆìŠ¤(ì‘ê²Œ)
  let score=0;
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const p=s.board[r][c];
    if(!p) continue;
    const sign = (p.c==='w')? 1 : -1;
    score += sign * PIECE_VAL[p.t];
  }
  // í™œë™ì„±
  const wMoves = legalMovesIn(s,'w').length;
  const bMoves = legalMovesIn(s,'b').length;
  score += 0.05 * (wMoves - bMoves);
  // ì²´í¬ ë³´ë„ˆìŠ¤/íŒ¨ë„í‹°
  if(inCheck(s,'b')) score += 10;
  if(inCheck(s,'w')) score -= 10;
  return (pov==='w') ? score : -score;
}

/* ë‚œì´ë„ë³„ ìˆ˜ ì„ íƒ */
function chooseAIMove(level, color){
  const moves = legalMovesIn(state, color);
  if(moves.length===0) return null;

  if(level==='easy'){
    return moves[(Math.random()*moves.length)|0];
  }

  if(level==='medium'){
    // 1í”Œë¼ì´ íœ´ë¦¬ìŠ¤í‹±: ì¡ê¸°/ì²´í¬/í”„ë¡œëª¨ì…˜ ê°€ì¤‘
    let best=null, bestScore=-1e9;
    for(const m of moves){
      let score=0;
      const target = state.board[m.tr][m.tc];
      if(target) score += PIECE_VAL[target.t] * 1.1; // ì¡ê¸° ê°€ì¹˜
      // ê²°ê³¼ ì²´í¬/ë©”ì´íŠ¸ ê°€ì¤‘
      const promo = m.promo ? 900 : 0;
      const ns = applyMove(state, m.sr,m.sc,m.tr,m.tc, m.promo?'Q':null);
      if(inCheck(ns, ns.turn)) score += 25; // ìƒëŒ€ì—ê²Œ ì²´í¬
      score += promo;
      // ë§ ì „ê°œ ì†Œí­
      score += (m.sr===6 && state.board[m.sr][m.sc].t==='P') ? 2 : 0;
      if(score>bestScore){ bestScore=score; best=m; }
    }
    return best || moves[0];
  }

  // hard: ë¯¸ë‹ˆë§¥ìŠ¤(ê¹Šì´ 3) + ì•ŒíŒŒë² íƒ€
  const maxDepth=3;
  const pov=color;

  function minimax(s, depth, alpha, beta, maximizing){
    const side = maximizing ? pov : (pov==='w'?'b':'w');
    if(depth===0){ return evaluateBoardSimple(s, pov); }

    const lm = legalMovesIn(s, side);
    if(lm.length===0){
      // ì²´í¬ë©”ì´íŠ¸/ìŠ¤í…Œì¼
      if(inCheck(s, side)) return maximizing ? -99999 : 99999;
      return 0;
    }

    if(maximizing){
      let value=-1e9;
      for(const m of lm){
        const ns = applyMove(s, m.sr,m.sc,m.tr,m.tc, m.promo?'Q':null);
        const v = minimax(ns, depth-1, alpha, beta, false);
        value = Math.max(value, v);
        alpha = Math.max(alpha, value);
        if(beta<=alpha) break;
      }
      return value;
    }else{
      let value=1e9;
      for(const m of lm){
        const ns = applyMove(s, m.sr,m.sc,m.tr,m.tc, m.promo?'Q':null);
        const v = minimax(ns, depth-1, alpha, beta, true);
        value = Math.min(value, v);
        beta = Math.min(beta, value);
        if(beta<=alpha) break;
      }
      return value;
    }
  }

  let best=null, bestScore=-1e9;
  const rootMoves = moves.slice().sort((a,b)=>{
    // move ordering: captures/promotions first
    const av = (state.board[a.tr][a.tc]?.t ? PIECE_VAL[state.board[a.tr][a.tc].t] : 0) + (a.promo?900:0);
    const bv = (state.board[b.tr][b.tc]?.t ? PIECE_VAL[state.board[b.tr][b.tc].t] : 0) + (b.promo?900:0);
    return bv-av;
  });

  for(const m of rootMoves){
    const ns = applyMove(state, m.sr,m.sc,m.tr,m.tc, m.promo?'Q':null);
    const score = minimax(ns, maxDepth-1, -1e9, 1e9, false);
    if(score>bestScore){ bestScore=score; best=m; }
  }
  return best || moves[0];
}

/* ===================== ì´ë²¤íŠ¸ ===================== */
undoBtn.addEventListener('click', ()=>{ if(aiTimer){clearTimeout(aiTimer); aiTimer=null;} undo(); maybeAIMove(); });
resetBtn.addEventListener('click', ()=>{ if(aiTimer){clearTimeout(aiTimer); aiTimer=null;} reset(); });
flipBtn.addEventListener('click', flip);
resetColorsBtn.addEventListener('click', resetColors);
soundToggleBtn.addEventListener('click', toggleSound);

aiToggleBtn.addEventListener('click', ()=>{
  aiEnabled = !aiEnabled;
  aiToggleBtn.textContent = aiEnabled ? 'â¸ AI ì¤‘ì§€' : 'ğŸ¤– AI ì‹œì‘';
  maybeAIMove();
});
humanSideSel.addEventListener('change', (e)=>{
  humanSide = e.target.value;
  maybeAIMove();
});

/* ì‹œì‘ */
reset();
bindColorPickers();
applyPickerVars(); // ì´ˆê¸°ê°’ ë°˜ì˜
humanSide = humanSideSel.value;

</script>
</body>
</html>
